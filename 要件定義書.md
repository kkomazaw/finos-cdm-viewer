# FINOS CDM Viewer 要件定義書

## 1. プロジェクト概要

### 1.1 プロジェクト名
FINOS CDM Viewer - Visual Studio Code 拡張機能

### 1.2 作成日
2026-01-15

### 1.3 プロジェクト概要
FINOS Common Domain Model (CDM) を視覚的に参照・探索できるVS Code拡張機能を開発する。
本プロジェクトは、Rosetta DSLで記述されたCDMモデルの構造を理解しやすくし、開発者やビジネスアナリストがモデルを効率的に参照できるようにすることを目的とする。

---

## 2. 背景と目的

### 2.1 背景
FINOS CDMは、金融取引のライフサイクルを標準化したドメインモデルであり、Rosetta DSLという専用の言語で記述されている。現在、CDMの構造を理解するには:

- GitHubリポジトリのソースコード直接参照
- 公式ドキュメントサイト (https://cdm.finos.org/) の参照
- Rosetta Designアプリケーションの利用

が主な手段となっているが、VS Code上で開発しながらモデルを参照したいというニーズに対応するツールが存在しない。

### 2.2 目的
- **効率化**: VS Code上でCDMモデルを直接参照し、開発効率を向上
- **視覚化**: 複雑な型の階層構造や関連性を視覚的に理解可能にする
- **検索性**: 型定義や属性を素早く検索・参照できるようにする
- **統合性**: VS Codeの既存機能(定義ジャンプ等)と連携したシームレスな開発体験

---

## 3. 対象ユーザー

### 3.1 主要ユーザー
1. **CDMモデル開発者**: CDMの仕様を開発・貢献する技術者
2. **金融機関のエンジニア**: CDMを実装・活用するシステム開発者
3. **ビジネスアナリスト**: モデルを理解し業務要件を定義する人
4. **規制当局・監査担当者**: コンプライアンスや監査のための参照

### 3.2 想定スキルレベル
- **プログラミング経験**: 中級以上のソフトウェア開発経験
- **金融ドメイン知識**: 基本的な金融取引の理解
- **Rosetta DSL**: 不要(ビューアーで学習可能)

---

## 4. システム要件

### 4.1 プラットフォーム
- **種類**: Visual Studio Code 拡張機能
- **対応OS**: Windows / macOS / Linux (VS Codeがサポートする全環境)
- **VS Codeバージョン**: 1.85.0 以上

### 4.2 動作環境
- **Node.js**: 18.x 以上
- **メモリ**: 最小 4GB (推奨 8GB以上)
- **ディスク**: 100MB (拡張機能本体 + キャッシュ)

---

## 5. 機能要件

### 5.1 必須機能

#### 5.1.1 モデルブラウジング
**概要**: CDMモデルの構造を階層的にブラウズできる機能

**詳細要件**:
- パッケージ/ネームスペース階層の表示
- 型定義(Type, Data, Enum等)の一覧表示
- 各型の属性・メソッドの表示
- サイドバーパネルでのツリービュー実装

**表示情報**:
- 型名
- パッケージ名
- 型の種類(Type / Class / Enum / Interface)
- アクセス修飾子
- 継承関係

#### 5.1.2 全文検索機能
**概要**: モデル全体から型・属性・コメントを検索

**詳細要件**:
- 型名による検索
- 属性名による検索
- コメント・ドキュメント内のキーワード検索
- インクリメンタルサーチ対応
- 正規表現検索サポート
- 検索結果のハイライト表示

**検索対象**:
- すべてのRosettaソースファイル(.rosetta)
- 型定義
- 関数定義
- コメント・アノテーション

#### 5.1.3 定義ジャンプ
**概要**: 参照から定義元へ素早く移動

**詳細要件**:
- Go to Definition (F12) サポート
- Peek Definition (Alt+F12) サポート
- 型参照から型定義へのジャンプ
- パンくずリストによる階層表示
- 履歴機能(戻る/進む)

#### 5.1.4 関連図表示
**概要**: 型間の関係をグラフで視覚化

**詳細要件**:
- UML風のクラス図生成
- 継承関係の表示
- 依存関係の表示
- コンポジション/アグリゲーション関係の表示
- インタラクティブなグラフ操作(ズーム/パン)
- 特定の型を中心とした関連図生成
- エクスポート機能(SVG/PNG)

**グラフタイプ**:
- 継承ツリー
- 依存関係グラフ
- パッケージ依存図

### 5.2 推奨機能(優先度:中)

#### 5.2.1 ホバー情報表示
- 型や属性にマウスオーバーで詳細情報を表示
- ドキュメントコメントの表示
- 型シグネチャの表示

#### 5.2.2 シンボル一覧
- ファイル内のすべての型・関数をリスト表示
- ワークスペース全体のシンボル検索(Ctrl+T)

#### 5.2.3 参照箇所の検索
- Find All References 機能
- 型や属性が使用されている箇所をすべて表示

### 5.3 将来機能(優先度:低)

#### 5.3.1 エクスポート機能
- JSON Schema出力
- HTML ドキュメント生成
- OpenAPI / Swagger定義生成

#### 5.3.2 バージョン比較
- 異なるCDMバージョン間の差分表示
- 変更履歴の可視化

#### 5.3.3 コード生成
- TypeScript型定義の生成
- Java クラスの生成
- Python データクラスの生成

#### 5.3.4 カスタムフィルタ
- ドメイン別フィルタ(Derivatives / Securities Lending / Repo等)
- カスタムビューの保存・読み込み

---

## 6. 非機能要件

### 6.1 パフォーマンス
- **起動時間**: 拡張機能のアクティベーション 3秒以内
- **検索応答**: 検索結果の表示 1秒以内(1000ファイル規模)
- **グラフ描画**: 50ノードまでのグラフを2秒以内に描画
- **メモリ使用量**: 通常動作時 200MB以下

### 6.2 ユーザビリティ
- **直感的UI**: VS Codeの標準UIパターンに準拠
- **キーボードショートカット**: 主要機能にショートカット割り当て
- **レスポンシブ**: リアルタイムな操作フィードバック
- **エラーハンドリング**: わかりやすいエラーメッセージ

### 6.3 保守性
- **コード品質**: TypeScript strict mode対応
- **テストカバレッジ**: 80%以上
- **ドキュメント**: README、API docs完備
- **ログ**: デバッグ用の詳細ログ機能

### 6.4 拡張性
- **プラグイン機構**: カスタムビューの追加可能性
- **設定項目**: ユーザー設定による動作カスタマイズ
- **API公開**: 他の拡張機能との連携可能性

### 6.5 互換性
- **Rosettaバージョン**: 最新のRosetta DSL仕様に対応
- **CDMバージョン**: CDM 5.x系のサポート
- **後方互換**: 設定ファイルの後方互換性維持

---

## 7. 技術スタック(推奨)

### 7.1 開発言語・フレームワーク
```
開発言語: TypeScript 5.x
ランタイム: Node.js 18.x+
拡張機能API: VS Code Extension API 1.85+
パッケージマネージャ: npm または pnpm
```

### 7.2 主要ライブラリ

#### パーサー・AST処理
- **Rosetta パーサー**:
  - 既存のRosetta DSLパーサーを利用(要調査)
  - または、Tree-sitterベースのパーサー実装
  - 候補: `@rosetta-lang/rosetta-parser` (存在すれば)

#### グラフ可視化
```typescript
// オプション1: D3.js - 高度なカスタマイズが可能
import * as d3 from 'd3';

// オプション2: Cytoscape.js - グラフ理論に特化
import cytoscape from 'cytoscape';

// オプション3: vis-network - シンプルで軽量
import { Network } from 'vis-network';
```

**推奨**: Cytoscape.js
- グラフレイアウトアルゴリズムが豊富
- 大規模グラフのパフォーマンス良好
- VS Code WebViewとの統合が容易

#### UI コンポーネント
```typescript
// VS Code標準のWebview UI Toolkit
import {
  provideVSCodeDesignSystem,
  vsCodeButton,
  vsCodeTextField
} from '@vscode/webview-ui-toolkit';
```

#### テスト
```typescript
// ユニットテスト: Jest
import { jest } from '@jest/globals';

// VS Code拡張機能テスト
import * as vscode from 'vscode';
import { runTests } from '@vscode/test-electron';
```

### 7.3 アーキテクチャパターン

```
拡張機能の構成:
┌─────────────────────────────────────┐
│  VS Code Extension Host (Node.js)  │
│  ┌───────────────────────────────┐  │
│  │  Extension Activation         │  │
│  │  - Command Registration       │  │
│  │  - Tree View Provider         │  │
│  │  - Language Features          │  │
│  └───────────────────────────────┘  │
│  ┌───────────────────────────────┐  │
│  │  Rosetta Parser Service       │  │
│  │  - AST Generation             │  │
│  │  - Symbol Table Management    │  │
│  └───────────────────────────────┘  │
│  ┌───────────────────────────────┐  │
│  │  Graph Service                │  │
│  │  - Dependency Analysis        │  │
│  │  - Graph Data Generation      │  │
│  └───────────────────────────────┘  │
└─────────────────────────────────────┘
           ↕ (Message Passing)
┌─────────────────────────────────────┐
│  Webview Panel (Browser Context)   │
│  ┌───────────────────────────────┐  │
│  │  Graph Visualization          │  │
│  │  - Cytoscape.js Rendering     │  │
│  │  - User Interaction           │  │
│  └───────────────────────────────┘  │
└─────────────────────────────────────┘
```

### 7.4 プロジェクト構成

```
finos-cdm-viewer/
├── src/
│   ├── extension.ts              # エントリーポイント
│   ├── commands/                 # コマンド実装
│   │   ├── showGraph.ts
│   │   ├── searchSymbol.ts
│   │   └── goToDefinition.ts
│   ├── providers/                # VS Code Providers
│   │   ├── treeDataProvider.ts  # サイドバーツリー
│   │   ├── hoverProvider.ts     # ホバー情報
│   │   └── definitionProvider.ts # 定義ジャンプ
│   ├── services/                 # ビジネスロジック
│   │   ├── rosettaParser.ts     # Rosetta DSLパーサー
│   │   ├── symbolIndex.ts       # シンボルインデックス
│   │   └── graphBuilder.ts      # グラフ構築
│   ├── models/                   # データモデル
│   │   ├── rosettaAst.ts
│   │   └── symbolInfo.ts
│   ├── webview/                  # Webview UI
│   │   ├── graphView.ts
│   │   └── styles/
│   └── utils/                    # ユーティリティ
│       ├── logger.ts
│       └── cache.ts
├── media/                        # アイコン・画像
├── test/                         # テストコード
├── package.json                  # 拡張機能マニフェスト
├── tsconfig.json
└── README.md
```

### 7.5 開発ツール

```json
{
  "devDependencies": {
    "@types/vscode": "^1.85.0",
    "@types/node": "^18.x",
    "@typescript-eslint/eslint-plugin": "^6.0.0",
    "@typescript-eslint/parser": "^6.0.0",
    "eslint": "^8.0.0",
    "typescript": "^5.0.0",
    "jest": "^29.0.0",
    "@vscode/test-electron": "^2.3.0",
    "esbuild": "^0.19.0"
  }
}
```

---

## 8. データソース

### 8.1 CDMモデルの取得方法

**オプション1: ローカルリポジトリ参照**
- ユーザーがクローンしたローカルのCDMリポジトリを参照
- ワークスペース内の `rosetta-source/src` ディレクトリをスキャン
- 利点: オフライン動作、カスタマイズ対応
- 欠点: ユーザーがリポジトリをクローンする必要あり

**オプション2: GitHub API経由取得**
- GitHub APIで https://github.com/finos/common-domain-model からファイル取得
- キャッシュして高速化
- 利点: セットアップ不要
- 欠点: オンライン必須、APIレート制限

**推奨アプローチ**: オプション1 + オプション2のハイブリッド
1. まずワークスペース内のローカルリポジトリを探す
2. なければGitHub APIで取得
3. 設定で動作モード切り替え可能

### 8.2 パース対象ファイル

```
rosetta-source/src/main/rosetta/
├── base-*.rosetta              # 基本型定義
├── product-*.rosetta           # 金融商品定義
├── event-*.rosetta             # イベント定義
├── regulation-*.rosetta        # 規制関連
└── ...
```

---

## 9. ユーザーインターフェース

### 9.1 サイドバービュー

```
FINOS CDM EXPLORER
├── 📦 cdm.base
│   ├── 📄 Party
│   ├── 📄 Account
│   ├── 📄 Identifier
│   └── ...
├── 📦 cdm.product
│   ├── 📦 cdm.product.asset
│   │   ├── 📄 Security
│   │   └── 📄 Cash
│   └── 📦 cdm.product.template
│       └── 📄 ContractualProduct
├── 📦 cdm.event
│   └── ...
└── 📦 cdm.regulation
    └── ...
```

### 9.2 グラフビューWebview

```
┌─────────────────────────────────────────┐
│  Graph View: ContractualProduct         │
├─────────────────────────────────────────┤
│  [Layout: ↓] [Export ↓] [Filter ⚙]     │
├─────────────────────────────────────────┤
│                                         │
│     ┌───────────────┐                  │
│     │  Product      │                  │
│     └───────┬───────┘                  │
│             │ extends                  │
│     ┌───────▼───────────────┐          │
│     │ ContractualProduct    │          │
│     │ ─────────────────────│          │
│     │ + economicTerms       │          │
│     │ + parties             │◄─────┐   │
│     └───────┬───────────────┘      │   │
│             │ contains             │   │
│     ┌───────▼──────────┐           │   │
│     │  EconomicTerms   │           │   │
│     └──────────────────┘           │   │
│             │                      │   │
│     ┌───────▼──────┐               │   │
│     │   Payout     │               │   │
│     └──────────────┘               │   │
│                                    │   │
│                    ┌───────────┐   │   │
│                    │  Party    ├───┘   │
│                    └───────────┘       │
│                                         │
└─────────────────────────────────────────┘
```

### 9.3 コマンドパレット

```
> FINOS CDM: Show Type Graph
> FINOS CDM: Search Symbol
> FINOS CDM: Go to Definition
> FINOS CDM: Find All References
> FINOS CDM: Refresh Index
> FINOS CDM: Export Documentation
```

---

## 10. 設定項目

### 10.1 拡張機能設定(settings.json)

```jsonc
{
  // CDMソースの場所
  "finosCdm.sourcePath": "${workspaceFolder}/common-domain-model/rosetta-source",

  // データソースモード
  "finosCdm.sourceMode": "local", // "local" | "github" | "auto"

  // GitHub取得時のブランチ
  "finosCdm.githubBranch": "master",

  // キャッシュ設定
  "finosCdm.enableCache": true,
  "finosCdm.cacheExpiration": 3600, // 秒

  // グラフ表示設定
  "finosCdm.graph.layout": "dagre", // "dagre" | "cose" | "breadthfirst"
  "finosCdm.graph.maxNodes": 50,
  "finosCdm.graph.showInheritance": true,
  "finosCdm.graph.showDependencies": true,

  // 検索設定
  "finosCdm.search.caseSensitive": false,
  "finosCdm.search.useRegex": false,

  // パフォーマンス
  "finosCdm.indexOnStartup": true,
  "finosCdm.backgroundIndexing": true
}
```

---

## 11. 開発計画

### 11.1 フェーズ1: 基本実装(MVP)
**期間**: 開発開始から Phase 1完了まで
**目標**: 基本的なブラウジングと検索機能の実装

**成果物**:
- [ ] VS Code拡張機能プロジェクトのセットアップ
- [ ] Rosetta DSLパーサーの実装または統合
- [ ] サイドバーツリービューの実装
- [ ] 基本的な型情報表示
- [ ] シンボル検索機能
- [ ] README、基本ドキュメント

**デリバラブル**:
- 動作する拡張機能(ローカルインストール可能)
- 基本機能のユニットテスト
- ユーザーガイド(README)

### 11.2 フェーズ2: 視覚化機能
**期間**: Phase 1完了後
**目標**: グラフビューと定義ジャンプの実装

**成果物**:
- [ ] Webviewベースのグラフビュー実装
- [ ] Cytoscape.jsによる関連図表示
- [ ] Go to Definition実装
- [ ] Hover情報表示
- [ ] グラフレイアウトアルゴリズムの最適化

**デリバラブル**:
- グラフビュー機能を含む拡張機能
- インタラクティブデモ
- スクリーンショット付きドキュメント

### 11.3 フェーズ3: 高度な機能
**期間**: Phase 2完了後
**目標**: エクスポート、バージョン比較などの付加機能

**成果物**:
- [ ] エクスポート機能(JSON/HTML)
- [ ] Find All References
- [ ] カスタムフィルタ機能
- [ ] パフォーマンス最適化
- [ ] VS Code Marketplace公開準備

**デリバラブル**:
- 機能完備版の拡張機能
- Marketplace公開用パッケージ
- 完全なドキュメント

### 11.4 フェーズ4: 公開とメンテナンス
**期間**: 継続的
**目標**: コミュニティフィードバックと改善

**活動**:
- [ ] VS Code Marketplaceへの公開
- [ ] ユーザーフィードバックの収集
- [ ] バグフィックス
- [ ] CDM新バージョンへの対応
- [ ] 機能追加・改善

---

## 12. テスト計画

### 12.1 ユニットテスト
- Rosettaパーサーのテスト
- シンボルインデックスのテスト
- グラフビルダーのテスト
- カバレッジ目標: 80%以上

### 12.2 統合テスト
- VS Code Extension APIとの統合
- コマンド実行のテスト
- Webviewとの通信テスト

### 12.3 E2Eテスト
- 実際のCDMリポジトリでの動作確認
- ユーザーシナリオテスト
  - モデルのブラウジング
  - 型の検索
  - グラフの表示

### 12.4 パフォーマンステスト
- 大量ファイルのパース速度
- 検索応答時間
- メモリ使用量
- グラフ描画速度

---

## 13. リスクと対策

### 13.1 技術リスク

| リスク | 影響度 | 発生確率 | 対策 |
|--------|--------|----------|------|
| Rosetta DSLパーサーが存在しない | 高 | 中 | Tree-sitterでパーサー自作、またはREGnosysに問い合わせ |
| パフォーマンス問題 | 中 | 中 | インクリメンタルパース、キャッシュ戦略 |
| グラフが複雑すぎて表示困難 | 中 | 低 | ノード数制限、サブグラフ表示 |

### 13.2 プロジェクトリスク

| リスク | 影響度 | 発生確率 | 対策 |
|--------|--------|----------|------|
| CDM仕様の大幅変更 | 中 | 低 | バージョン別対応、設定で切り替え |
| ユーザー需要不足 | 低 | 低 | FINOSコミュニティでフィードバック収集 |
| 保守工数不足 | 中 | 中 | ドキュメント整備、コントリビューター募集 |

---

## 14. 成功基準

### 14.1 技術的成功基準
- [ ] すべての主要機能が正常に動作する
- [ ] テストカバレッジ80%以上達成
- [ ] パフォーマンス要件を満たす
- [ ] VS Code Marketplaceで公開可能な品質

### 14.2 ビジネス的成功基準
- [ ] VS Code Marketplaceで100以上のインストール(3ヶ月以内)
- [ ] FINOSコミュニティでの認知獲得
- [ ] 肯定的なフィードバック(星4以上)
- [ ] アクティブなユーザーコミュニティ形成

---

## 15. 参考資料

### 15.1 FINOS CDM関連
- FINOS CDM GitHub: https://github.com/finos/common-domain-model
- CDM公式サイト: https://cdm.finos.org/
- Rosetta Technology: https://rosetta-technology.io/

### 15.2 技術資料
- VS Code Extension API: https://code.visualstudio.com/api
- Cytoscape.js: https://js.cytoscape.org/
- Tree-sitter: https://tree-sitter.github.io/tree-sitter/

### 15.3 関連プロジェクト
- Rosetta VS Code Plugin: https://github.com/REGnosys/rosetta-dsl/tree/master/rosetta-ide/vscode
- PlantUML Extension: https://marketplace.visualstudio.com/items?itemName=jebbs.plantuml

---

## 16. 承認

| 役割 | 氏名 | 承認日 | 署名 |
|------|------|--------|------|
| プロジェクトオーナー | | | |
| 技術リード | | | |
| レビュアー | | | |

---

## 改訂履歴

| バージョン | 日付 | 変更内容 | 作成者 |
|-----------|------|----------|--------|
| 1.0 | 2026-01-15 | 初版作成 | AI Assistant |

---

## 付録

### A. 用語集

| 用語 | 説明 |
|------|------|
| CDM | Common Domain Model - 金融取引の標準ドメインモデル |
| Rosetta DSL | CDMを記述するためのドメイン固有言語 |
| FINOS | Fintech Open Source Foundation |
| AST | Abstract Syntax Tree - 抽象構文木 |
| Tree-sitter | インクリメンタルパーサー生成ツール |

### B. 技術検証項目

開発開始前に以下を調査・検証する必要がある:

1. **Rosettaパーサーの存在確認**
   - 既存のTypeScript/JavaScriptパーサーライブラリの有無
   - REGnosysが提供するツールの調査

2. **VS Code拡張機能の制約事項**
   - Webviewでのグラフ描画パフォーマンス
   - 大量ファイルの処理能力

3. **CDMリポジトリ構造の詳細分析**
   - 最新のファイル構成
   - パース対象となるRosettaファイルの規模

---

**以上**
